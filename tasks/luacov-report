;; -*- mode: fennel; -*- vi:ft=fennel

(local cleanup
  "rm -rf luacov.* &&
   for file in $(find -type f -name '*.lua'); do rm $file; done")

(local script
  "fennel --correlate -c test/httpbin-test.fnl > test/httpbin-test.lua &&
   touch http.lua &&
   for file in $(find -type f -name '*.fnl' | grep 'http/'); do fennel --correlate -c $file > ${file%.fnl}.lua; done &&
   fennel --correlate -c lib/async.fnl > lib/async.lua &&
   fennel --correlate -c lib/fennel-test.fnl > lib/fennel-test.lua &&
   lua -lluarocks.loader -lluacov test/httpbin-test.lua &&
   luacov-console . &&
   luacov-console -l 'http.*' &&
   luacov-console -s")

(with-open [_ (io.popen cleanup)])
(with-open [proc (io.popen script)]
  (each [line (proc:lines)]
    (print line)))
(with-open [_ (io.popen cleanup)])
